name: Build CVE Database

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      years:
        description: 'Number of years to include'
        required: false
        default: '10'
        type: string
      cvec_commit:
        description: 'Specific commit SHA from cvec repository'
        required: false
        default: 'main'
        type: string

env:
  PYTHON_VERSION: '3.12'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout cvec-db
        uses: actions/checkout@v4
        
      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          
      - name: Set up Python
        run: uv python install ${{ env.PYTHON_VERSION }}
        
      - name: Create virtual environment
        run: uv venv
        
      - name: Install dependencies
        run: |
          CVEC_COMMIT=${{ github.event.inputs.cvec_commit || 'main' }}
          # Install cvec from specific commit
          # uv pip install "cvec @ git+https://github.com/${{ github.repository_owner }}/cvec.git@${CVEC_COMMIT}"
          # Install cvec-db
          uv tool install "cvec[semantic] @ git+https://github.com/${{ github.repository_owner }}/cvec.git@7053e40f8a077d83a78d78ce2f6c7534dcd18a6a"
          # uv tool install -e .
          
      - name: Build database
        run: |
          YEARS=${{ github.event.inputs.years || '10' }}
          # uv run cvec-db build --years $YEARS --output data
          cvec db build download-json --years $YEARS -d data/
          cvec db build extract-parquet --years $YEARS -d data/
          cvec db build extract-embeddings -d data/ -v 
          cvec db build create-manifest -d data/ -s "TMP CI"

      - name: List generated files
        run: |
          ls -lh data/
          cat data/manifest.json
          
      - name: Create release tag
        id: tag
        run: |
          DATE=$(date -u +"%Y%m%d")
          echo "tag=v${DATE}" >> $GITHUB_OUTPUT
          echo "date=${DATE}" >> $GITHUB_OUTPUT
          
      - name: Delete existing release with same tag (if any)
        run: |
          gh release delete ${{ steps.tag.outputs.tag }} --yes || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: CVE Database ${{ steps.tag.outputs.date }}
          body: |
            Automated CVE database release.
            
            Generated at: ${{ steps.tag.outputs.date }}
            
            ## Files included
            - `cves.parquet` - Core CVE metadata
            - `cve_descriptions.parquet` - CVE descriptions
            - `cve_metrics.parquet` - CVSS metrics
            - `cve_products.parquet` - Affected products
            - `cve_versions.parquet` - Version ranges
            - `cve_cwes.parquet` - CWE mappings
            - `cve_references.parquet` - References
            - `cve_credits.parquet` - Credits
            - `cve_tags.parquet` - Tags
            - `cve_embeddings.parquet` - Embeddings for semantic search
            - `manifest.json` - Metadata and checksums
            
            ## Usage
            Download with cvec tool:
            ```bash
            cvec db update
            ```
          files: |
            data/*.parquet
            data/manifest.json
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
